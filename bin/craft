#!/usr/bin/env bash

START="$(date +%s)"
export START

quiet_cd() {
	cd "$@" &>/dev/null || return
}

# Env variables
# Resolve symlink to get the actual script location
if [ -L "$0" ]; then
	# Script is a symlink, resolve it
	CRAFT_FILE="$(readlink -f "$0")"
else
	# Script is not a symlink
	CRAFT_FILE="$0"
fi
export CRAFT_HOME_DIR="${CRAFT_FILE%/*/*}"
export CRAFT_LIB="${CRAFT_HOME_DIR}/lib"
export CRAFT_SERVER_DIR="/opt/craft/servers"

# Load common functions
# shellcheck source=lib/common.sh
source "${CRAFT_LIB}/common.sh"

# Check for aliases
args=("$@")

# shellcheck disable=SC2034
declare -A alias_map=(
	["--help"]="-h"
	["--list"]="-ls"
	["--version"]="-v"
)
new_args=()
while IFS= read -r line; do
	new_args+=("$line")
done < <(replace_alias_args alias_map "${args[@]}")

set -- "${new_args[@]}"

# Command variable
command="craft"
fun="${1}"

# Look for command
[ -z "$1" ] && command_help "$command" 1

# Execute command
shift
# Validate command name to avoid sourcing unexpected files
if [[ "$fun" =~ ^[A-Za-z0-9_-]+$ ]] && [ -f "${CRAFT_LIB}/$fun.sh" ]; then
	# shellcheck disable=SC1090  # dynamic but validated file name
	source "${CRAFT_LIB}/$fun.sh"
	"${fun}"_command "$@"
else
	invalid_command "$command" "${fun}"
fi
