#!/usr/bin/env bash

START="$(date +%s)"
export START

quiet_cd() {
	cd "$@" &>/dev/null || return
}

# Env variables
CRAFT_FILE_DIRECTORY="$(quiet_cd "${0%/*}/" && pwd -P)"
CRAFT_FILE="${CRAFT_FILE_DIRECTORY%/}/${0##*/}"
export CRAFT_HOME_DIR="${CRAFT_FILE%/*/*}"
export CRAFT_LIB="${CRAFT_HOME_DIR}/lib"
export CRAFT_SERVER_DIR="/opt/craft/servers"

# Load common functions
# shellcheck source=lib/common.sh
source "${CRAFT_LIB}/common.sh"

# Check for aliases
args=("$@")
# shellcheck disable=SC2207
args=($(replace_alias_args "--help" "-h" "${args[@]}"))
# shellcheck disable=SC2207
args=($(replace_alias_args "--list" "-ls" "${args[@]}"))
# shellcheck disable=SC2207
args=($(replace_alias_args "--version" "-v" "${args[@]}"))
set -- "${args[@]}"

# Command variable
command="craft"
fun="${1}"

# Look for command
[ -z "$1" ] && command_help "$command" 1

# Execute command
shift
# Validate command name to avoid sourcing unexpected files
if [[ "$fun" =~ ^[A-Za-z0-9_-]+$ ]] && [ -f "${CRAFT_LIB}/$fun.sh" ]; then
	# shellcheck disable=SC1090  # dynamic but validated file name
	source "${CRAFT_LIB}/$fun.sh"
	"${fun}"_command "$@"
else
	invalid_command "$command" "${fun}"
fi
